name: All - Lint, Test, Build & Deploy to Render

# ─── When to run ────────────────────────────────────────────────────────────────
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# ─── Prevent multiple runs at once for same branch/PR ───────────────────────────
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ─── Define jobs ────────────────────────────────────────────────────────────────
jobs:
  # ── Lint & Format check (optional but recommended) ───────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'                     # automatic npm cache

      - name: Install dependencies
        run: npm ci

      - name: Run lint                # ← add "lint": "eslint ." to package.json later
        run: npm run lint || true       # || true = don't fail CI yet if you don't have lint

  # ── Test job ────────────────────────────────────────────────────────────────────
  test:
    runs-on: ubuntu-latest
    needs: [lint]                     # run after lint (optional dependency)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test
        env:
          CI: true                      # tells Jest it's in CI mode (no watch)

  # ── Build check (ensures app starts without errors) ─────────────────────────────
  build:
    runs-on: ubuntu-latest
    needs: [test]                     # only if tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build / Verify start     # for Express usually just "npm start" smoke test
        run: npm start & sleep 5 && pkill node   # start server 5s → kill (smoke test)

  # ── Deploy only on main branch pushes ──────────────────────────────────────────
  deploy:
    runs-on: ubuntu-latest
    needs: [lint, test, build]        # all previous must pass
    if: github.ref == 'refs/heads/main'   # only main → deploy

    steps:
      - name: Checkout code           # needed if you want to see code in logs
        uses: actions/checkout@v4

      - name: Trigger Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Missing Render secrets → skipping deploy"
            exit 0
          fi

          curl -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys"

          echo "Deploy triggered on Render!"